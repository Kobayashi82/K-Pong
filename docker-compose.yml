
services:

  # Nginx
  nginx:
    container_name: nginx                             # Nombre del contenedor
    build:
      context: ./nginx                                # Ubicacion del Dockerfile de nginx
      dockerfile: Dockerfile
    volumes:
      - ./frontend:/usr/share/nginx/html              # Monta la carpeta frontend en Nginx (los cambios son instantaneos)
      - ./certs:/certs                                  # Montar el volumen en la ubicaci√≥n deseada dentro de Prometheus
    ports:
      - "80:80"                                       # Puerto para HTTP
      - "443:443"                                     # Puerto para HTTPS
    networks:
      - pong-net                                      # Red que conecta todos los contenedores
    depends_on:
      - service1                                      # Dependencia de service1

  # PostgreSQL
  db:
    container_name: postgre                           # Nombre del contenedor
    image: postgres:13
    env_file: .env                                    # Archivo con las variables de entorno
    ports:
      - "5432:5432"                                   # Puerto de PostgreSQL
    volumes:
      - pgdata:/var/lib/postgresql/data               # Volumen donde se guardan los archivos de la base de datos (para que no se borren al desmontar los contenedores)
    networks:
      - pong-net                                      # Red que conecta todos los contenedores

  # Prometheus
  prometheus:
      container_name: prometheus                      # Nombre del contenedor
      build:
        context: ./prometheus                         # Ubicacion del Dockerfile de prometheus
        dockerfile: Dockerfile
      ports:
        - "9090:9090"                                 # Puerto de prometheus
      networks:
        - pong-net                                    # Red que conecta todos los contenedores

  # Grafana
  grafana:
    container_name: grafana                           # Nombre del contenedor
    image: grafana/grafana
    ports:
      - "3000:3000"                                   # Puerto de grafana
    environment:
    - GF_SERVER_ROOT_URL=https://localhost/grafana/
    networks:
      - pong-net                                      # Red que conecta todos los contenedores
        
  # MicroServices
  service1:
    container_name: service1                          # Nombre del contenedor
    env_file: .env                                    # Archivo con las variables de entorno
    build:
      context: ./backend/service1                     # Ubicacion del Dockerfile del microservicio
      dockerfile: Dockerfile
    volumes:
      - ./backend/service1:/app                       # Monta la carpeta del microservicio en modo compartido (los cambios son instantaneos)
    ports:
      - "8001:8000"                                   # Puerto de "gunicorn" para las API Request
      - "9001:9000"                                   # Puerto de "daphne" para los WebSockets
    networks:
      - pong-net                                      # Red que conecta todos los contenedores
    depends_on:
      - prometheus                                    # Dependencia de prometheus
      - grafana                                       # Dependencia de grafana
      - db                                            # Dependencia de la base de datos

volumes:
  pgdata:                                             # Volumen donde se guardan los archivos de la base de datos (para que no se borren al desmontar los contenedores)

networks:
  pong-net:                                           # Red que conecta todos los contenedores
